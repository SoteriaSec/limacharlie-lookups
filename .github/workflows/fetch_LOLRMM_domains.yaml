name: Update RMM Domain & IP & URL Lookup Lists

on:
  schedule:
    # Every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-lookup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Download LOLRMM CSV
        run: |
          curl -sL \
            https://raw.githubusercontent.com/magicsword-io/LOLRMM/main/website/public/api/rmm_domains.csv \
            -o rmm_domains.csv

      - name: Extract lookups & write JSON files
        run: |
          mkdir -p LOLRMM-Domains

          python3 <<'EOF'
          import csv, json, re

          domains = {}
          ips = {}
          urls = {}

          # IPv4 regex
          ipv4_re = re.compile(r'^\d{1,3}(?:\.\d{1,3}){3}$')

          def add_entry(target_dict, key, tool_name):
              target_dict[key] = {"RMM Tool": tool_name}

          # Prefer DictReader so the first row is treated as headers and skipped automatically.
          with open("rmm_domains.csv", newline="") as f:
              reader = csv.DictReader(f)

              # The LOLRMM CSV currently uses these headers:
              #   URI,RMM_Tool
              # We'll also tolerate minor variations just in case.
              uri_keys = ["URI", "Uri", "uri"]
              tool_keys = ["RMM_Tool", "RMM Tool", "Tool", "tool", "rmm_tool"]

              for row in reader:
                  if not row:
                      continue

                  indicator = None
                  for k in uri_keys:
                      if k in row and row[k] is not None:
                          indicator = row[k]
                          break

                  tool_name = ""
                  for k in tool_keys:
                      if k in row and row[k] is not None:
                          tool_name = row[k]
                          break

                  if indicator is None:
                      continue

                  # Strip leading/trailing spaces, and newline cruft
                  indicator = str(indicator).strip()
                  tool_name = str(tool_name).strip()

                  if not indicator:
                      continue

                  # Wildcard/leading dot handling
                  trimmed = indicator.lstrip(".*")
                  if not trimmed:
                      continue

                  # classify as URL if it contains a slash
                  if "/" in trimmed:
                      key = trimmed.lower()
                      add_entry(urls, key, tool_name)

                  # classify as IP
                  elif ipv4_re.match(trimmed):
                      key = trimmed
                      add_entry(ips, key, tool_name)

                  # otherwise it's a domain
                  else:
                      key = trimmed.lower()
                      add_entry(domains, key, tool_name)

          # sort each and write out as JSON objects
          for filename, data in [
              ("LOLRMM-Domains/rmm-domain-lookup-list.json", domains),
              ("LOLRMM-Domains/rmm-ip-lookup-list.json", ips),
              ("LOLRMM-Domains/rmm-urls-lookup-list.json", urls),
          ]:
              ordered = {k: data[k] for k in sorted(data)}
              with open(filename, "w") as out:
                  json.dump(ordered, out, indent=2)
          EOF

      - name: Commit & push lookup files
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add LOLRMM-Domains/rmm-domain-lookup-list.json \
                  LOLRMM-Domains/rmm-ip-lookup-list.json \
                  LOLRMM-Domains/rmm-urls-lookup-list.json
          if git diff --cached --quiet; then
            echo "No changes to lookup lists"
          else
            git commit -m "chore: update RMM domain, IP, and URL lookup lists"
            git push
          fi
